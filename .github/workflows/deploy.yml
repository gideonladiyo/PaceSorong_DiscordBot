name: CI/CD Pipeline bot Discord Pace Papua
description: CICD pipeline for Discord Bot Pace Papua

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy-bot:
    name: Deploy Discord Bot to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "‚úÖ Connected to server"
            
            # Navigate to project directory or create it
            if [ ! -d "/home/PaceSorong_DiscordBot" ]; then
              echo "üìÇ Creating project directory"
              mkdir -p /home/PaceSorong_DiscordBot
            fi
            cd /home/PaceSorong_DiscordBot
            
            # Clone or pull latest changes
            if [ ! -d ".git" ]; then
              echo "üì• Cloning repository"
              git clone https://github.com/your-repo/PaceSorong_DiscordBot.git .
            else
              echo "üì• Pulling latest changes"
              git config --global --add safe.directory /home/PaceSorong_DiscordBot
              git pull origin main
            fi

            if ! command -v docker &> /dev/null; then
              echo "üê≥ Installing Docker"
              sudo apt-get update
              sudo apt-get install -y docker.io
              sudo systemctl start docker
              sudo systemctl enable docker
            fi
            
            
            if ! groups $USER | grep -q '\bdocker\b'; then
              echo "üë• Adding user to docker group"
              sudo usermod -aG docker $USER
              newgrp docker
            fi
            
            echo "üê≥ Building and running Docker container"
            docker stop pace-discord-bot || true
            docker rm pace-discord-bot || true
            docker build -t pace-discord-bot .
            
            # Run with environment variables from GitHub Secrets
            docker run -d \
              --name pace-discord-bot \
              -e GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }} \
              -e DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }} \
              pace-discord-bot
            
            echo "üöÄ Bot successfully deployed"