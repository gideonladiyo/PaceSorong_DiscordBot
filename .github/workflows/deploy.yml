name: CI/CD Pipeline bot Discord Pace Papua
description: CICD pipeline for Discord Bot Pace Papua

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy-bot:
    name: Deploy Discord Bot to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            REPO_URL="https://github.com/gideonladiyo/PaceSorong_DiscordBot.git"
            APP_DIR="/home/gideonladiyo/PaceSorong_DiscordBot"
            CONTAINER_NAME="pace-discord-bot"

            echo "‚úÖ Memastikan direktori proyek tersedia"
            if [ ! -d "$APP_DIR" ]; then
                echo "üìÅ Direktori belum ada, membuat direktori..."
                mkdir -p "$APP_DIR"
            fi

            cd "$APP_DIR"

            if [ ! -d ".git" ]; then
                echo "üîÑ Folder belum berisi repo Git, melakukan clone..."
                rm -rf "$APP_DIR"/*
                git clone "$REPO_URL" "$APP_DIR"
            fi

            echo "üì• Menandai folder git sebagai aman"
            sudo git config --global --add safe.directory "$APP_DIR"

            echo "üì• Pulling latest changes..."
            sudo git pull origin main

            echo "üê≥ Mengecek apakah container $CONTAINER_NAME sedang berjalan"
            if [ "$(sudo docker ps -aq -f name=$CONTAINER_NAME)" ]; then
                echo "üõë Menghentikan dan menghapus container lama..."
                sudo docker stop $CONTAINER_NAME
                sudo docker rm $CONTAINER_NAME
            fi

            echo "üê≥ Membuild dan menjalankan kontainer Docker"
            sudo docker build -t $CONTAINER_NAME .
            sudo docker run -d \
              --name $CONTAINER_NAME \
              --env-file .env \
              -v "$APP_DIR/data:/app/data" \
              $CONTAINER_NAME

            echo "üöÄ Bot berhasil dideploy